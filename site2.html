<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Site B — 位置確認</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif; padding:20px; }
    pre { background:#f6f8fa; padding:10px; border-radius:6px; white-space:pre-wrap; word-break:break-word; }
    .meta { color:#666; font-size:0.9em; margin-bottom:8px; }
    button { margin-right:8px; padding:6px 10px; }
  </style>
</head>
<body>
  <h1>Site B — 位置確認ページ</h1>
  <div class="meta" id="meta">読み込み中...</div>
  <div>
    <button id="refreshBtn">最新を取得</button>
    <button id="openMapBtn">Google Mapsで開く（位置ありの場合）</button>
  </div>
  <pre id="out">--</pre>

<script>
const API_BASE = ''; // 同一 origin なら空欄。別サーバなら 'https://example.com' のように変更。
const out = document.getElementById('out');
const meta = document.getElementById('meta');
let lastData = null;

function getQuery(name) {
  return new URLSearchParams(location.search).get(name);
}

async function fetchLocation(sessionId, token) {
  const url = API_BASE + '/api/session?sessionId=' + encodeURIComponent(sessionId);
  const res = await fetch(url, {
    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
  });
  if (!res.ok) {
    const txt = await res.text();
    throw new Error('fetch failed: ' + res.status + ' ' + txt);
  }
  return res.json();
}

function formatTimestamp(ts) {
  if (!ts) return '';
  try { const d = new Date(ts); return d.toLocaleString(); } catch (e) { return String(ts); }
}

function render(data) {
  lastData = data;
  if (!data) { out.textContent = 'データなし'; meta.textContent = ''; return; }
  const lines = [];
  lines.push('sessionId: ' + (data.sessionId || ''));
  lines.push('createdAt: ' + (data.createdAt ? formatTimestamp(data.createdAt) : ''));
  lines.push('updatedAt: ' + (data.updatedAt ? formatTimestamp(data.updatedAt) : ''));
  lines.push('');
  lines.push('記録された IP: ' + (data.ip || '(なし)'));
  lines.push('');
  if (data.reported && data.reported.payload) {
    const payload = data.reported.payload;
    lines.push('ペイロード:');
    for (const k of Object.keys(payload)) {
      lines.push(`  ${k}: ${JSON.stringify(payload[k])}`);
    }
    if (data.reported.ip) {
      lines.push('');
      lines.push('報告元IP（サーバ側記録）: ' + data.reported.ip);
    }
  } else if (data.lastLocation) {
    const loc = data.lastLocation;
    lines.push('位置情報:');
    lines.push('  緯度: ' + loc.latitude);
    lines.push('  経度: ' + loc.longitude);
    lines.push('  精度 (m): ' + (loc.accuracy ?? '不明'));
    lines.push('  取得時刻: ' + (loc.timestamp ? formatTimestamp(loc.timestamp) : ''));
    lines.push('');
    const mapLink = `https://www.google.com/maps?q=${encodeURIComponent(loc.latitude + ',' + loc.longitude)}`;
    lines.push('Google Maps: ' + mapLink);
  } else {
    lines.push('位置情報は未送信です（ユーザーが拒否したかまだ送信されていません）。');
  }
  out.textContent = lines.join('\n');
  meta.textContent = '取得日時: ' + new Date().toLocaleString();
}

document.getElementById('refreshBtn').addEventListener('click', loadAndRender);
document.getElementById('openMapBtn').addEventListener('click', () => {
  if (!lastData) { alert('データがありません。'); return; }
  const payload = lastData.reported?.payload || lastData.lastLocation;
  const lat = payload?.latitude || (payload?.geoText ? payload.geoText.split(',')[0] : null);
  const lon = payload?.longitude || (payload?.geoText ? payload.geoText.split(',')[1] : null);
  if (!lat || !lon) { alert('位置情報がありません。'); return; }
  const url = `https://www.google.com/maps?q=${encodeURIComponent(lat + ',' + lon)}`;
  window.open(url, '_blank');
});

async function loadAndRender() {
  out.textContent = 'サーバから取得中...';
  const sessionId = getQuery('sessionId');
  const token = getQuery('token');
  if (!sessionId) {
    out.textContent = 'sessionId と token が必要です（クエリに含めてください）。';
    meta.textContent = '';
    return;
  }
  try {
    const data = await fetchLocation(sessionId, token);
    render(data);
  } catch (e) {
    out.textContent = '取得中にエラーが発生しました: ' + e.message;
    meta.textContent = '';
    console.error(e);
  }
}

window.addEventListener('load', loadAndRender);
</script>
</body>
</html>