<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Site B — 位置確認</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto,
        "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      padding:20px;
    }
    pre {
      background:#f6f8fa;
      padding:10px;
      border-radius:6px;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .meta {
      color:#666;
      font-size:0.9em;
      margin-bottom:8px;
    }
    button {
      margin-right:8px;
      padding:6px 10px;
    }
  </style>
</head>
<body>
  <h1>Site B — 位置確認ページ</h1>
  <div class="meta" id="meta">読み込み中...</div>
  <div>
    <button id="refreshBtn">最新を取得</button>
    <button id="openMapBtn">Google Mapsで開く（位置ありの場合）</button>
  </div>
  <pre id="out">--</pre>

<script>
/* ===== 設定 ===== */
const API_BASE = ''; // 同一 origin なら空欄でOK

const out  = document.getElementById('out');
const meta = document.getElementById('meta');
let lastData = null;

/* ===== util ===== */
function getQuery(name) {
  return new URLSearchParams(location.search).get(name);
}

function formatTimestamp(ts) {
  if (!ts) return '';
  try {
    return new Date(ts).toLocaleString();
  } catch {
    return String(ts);
  }
}

/* ===== API ===== */
async function fetchLocation(sessionId) {
  const url = API_BASE + '/api/session?sessionId=' + encodeURIComponent(sessionId);
  const res = await fetch(url);
  if (!res.ok) {
    const txt = await res.text();
    throw new Error(res.status + ' ' + txt);
  }
  return res.json();
}

/* ===== render ===== */
function render(data) {
  lastData = data;
  const lines = [];

  lines.push('sessionId: ' + (data.sessionId || ''));
  lines.push('createdAt: ' + formatTimestamp(data.createdAt));
  lines.push('updatedAt: ' + formatTimestamp(data.updatedAt));
  lines.push('');
  lines.push('記録された IP: ' + (data.ip || '(なし)'));
  lines.push('');

  if (data.reported && data.reported.payload) {
    lines.push('送信された情報:');
    for (const [k, v] of Object.entries(data.reported.payload)) {
      lines.push(`  ${k}: ${JSON.stringify(v)}`);
    }
    if (data.reported.ip) {
      lines.push('');
      lines.push('報告元IP（サーバ側）: ' + data.reported.ip);
    }
  } else {
    lines.push('まだレポートは届いていません。');
  }

  out.textContent = lines.join('\n');
  meta.textContent = '取得日時: ' + new Date().toLocaleString();
}

/* ===== handlers ===== */
async function loadAndRender() {
  out.textContent = 'サーバから取得中...';
  meta.textContent = '';

  const sessionId = getQuery('sessionId');

  // ★ 修正ポイント：token 不要、sessionId だけ必須
  if (!sessionId) {
    out.textContent = 'sessionId が必要です（URLに ?sessionId=xxx を付けてください）';
    return;
  }

  try {
    const data = await fetchLocation(sessionId);
    render(data);
  } catch (e) {
    out.textContent = '取得エラー: ' + e.message;
    console.error(e);
  }
}

document.getElementById('refreshBtn')
  .addEventListener('click', loadAndRender);

document.getElementById('openMapBtn')
  .addEventListener('click', () => {
    if (!lastData?.reported?.payload?.geoText) {
      alert('位置情報がありません');
      return;
    }
    const [lat, lon] = lastData.reported.payload.geoText.split(',');
    if (!lat || !lon) {
      alert('位置情報が不正です');
      return;
    }
    window.open(
      `https://www.google.com/maps?q=${encodeURIComponent(lat + ',' + lon)}`,
      '_blank'
    );
  });

window.addEventListener('load', loadAndRender);
</script>
</body>
</html>

